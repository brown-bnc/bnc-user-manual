---
hidden: true
---

# V1: Second-Level Analysis using gen\_group\_command.py

Second-level analysis takes the results from the first-level analysis (individual subjects) and combines them across participants. This allows us to make inferences about the population as a whole, rather than just describing one person’s brain activity.

In some studies, researchers might compare different groups (e.g., males vs. females, patients vs. controls). However, in our case all subjects in _Demodat2_ performed the same task, and we did not divide them into subgroups. Therefore, we will use a **one-sample test** to examine whether the group, as a whole, shows consistent brain activation.

## Use gen\_group\_command.py to build your statistical tests and run the group analysis

Similar to how afniproc.py generates a processing script per subject, AFNI's [gen\_group\_command.py](https://afni.nimh.nih.gov/pub/dist/doc/program_help/gen_group_command.py.html) generates group analyses scripts. We will be using this meta-script to write two variations of group analysis: one using the afni command `3dttest++`, and one with `3dMEMA`.&#x20;

{% hint style="info" %}
Since we are working with a very low n in this tutorial, it is not unusual to observe few clusters that survive thresholding at the group level. These scripts are meant to serve as an example and should be adapted for a larger dataset.&#x20;
{% endhint %}

### 3dttest++

[3dttest++](https://afni.nimh.nih.gov/pub/dist/doc/program_help/3dttest++.html) is an afni command that performs a simple t-test across 3D datasets. Beta coefficients from all three subjects (6 sessions) are included in a one sample t-test that is generated by gen\_group\_command.py. Unlike afniproc.py, there is no execute flag, so we must execute the tsch script generated by gen\_group\_command.py manually, after the script is created. Additionally, separate statistical tests are run for the two tasks (visual checkerboard and keypress).&#x20;

{% code title="gen_group_command_3dttest.sh" %}
```bash
#!/bin/bash
#SBATCH -N 1
#SBATCH -c 8
#SBATCH --mem=10G
#SBATCH --time 1:00:00
#SBATCH -J gen_group_command_3dttest
#SBATCH --output=logs/gen_group_command_3dttest-%A_%a.out
#SBATCH --mail-user example_user@brown.edu 
#SBATCH --mail-type ALL

# To run this, type on the terminal: sbatch gen_group_command_3dttest.sh

##########################################################################################################
########################### Create Group Results and Log Directories ###############################################
##########################################################################################################

bidsdir=/path/to/bids # <--- FILL THIS IN
outdir=$bidsdir/derivatives/afni/groupresults
mkdir -p "$outdir"

echo "Creating group results directory at $outdir"

# Copy group mask into output directory (You can use the group mask from any subject)

mask=$bidsdir/derivatives/afni/sub-101/dualsession/sub-101.dualsession.results/mask_group+tlrc.HEAD
mask_brik=${mask%.HEAD}.BRIK

if [[ -f "$mask" && -f "$mask_brik" ]]; then
    cp "$mask" "$mask_brik" "$outdir/"
    echo "Copied mask to output directory."
else
    echo "Missing mask."
fi

# Use the 'while read' loop to iterate over subjects.txt and copy data files
while read subID; do
    src=$bidsdir/derivatives/afni/${subID}/dualsession/${subID}.dualsession.results/stats.${subID}_dualsession_REML+tlrc.HEAD
    src_brik=${src%.HEAD}.BRIK

    if [[ -f "$src" && -f "$src_brik" ]]; then
        cp "$src" "$src_brik" "$outdir/"
        echo "Copied stats for $subID"
    else
        echo "Missing REML stats for $subID"
    fi
done < subjects.txt

logdir=$bidsdir/derivatives/afni/scripts/logs
mkdir -p $logdir

echo "Creating log directory at $logdir"

cd $outdir

##########################################################################################################
####################### Run Group Statistics with 3dttest++ ##############################################
##########################################################################################################

# Run 3dttest++ for the checks task
gen_group_command.py \
    -command 3dttest++ \
    -write_script cmd.ttest.checks  \
    -dsets $outdir/*REML*.HEAD  \
    -subs_betas "left_vs_right_chx#0_Coef" \
    -prefix ttest_group_checks_LR \
    -options -mask mask_group+tlrc

tcsh -xef cmd.ttest.checks |& tee $logdir/output.ttest.checks.log

# Run 3dttest++ for the keypress task
gen_group_command.py \
    -command 3dttest++ \
    -write_script cmd.ttest.keypress  \
    -dsets $outdir/*REML*.HEAD  \
    -subs_betas "left_vs_right_press#0_Coef" \
    -prefix ttest_group_keypress_LR \
    -options -mask mask_group+tlrc

tcsh -xef cmd.ttest.keypress |& tee $logdir/output.ttest.keypress.log

```
{% endcode %}

#### View the Output

In a terminal, navigate to the output directory and open AFNI by typing `afni` on the command line. Using the AFNI GUI, select `MNI152_2009_template.nii.gz` as the Underlay, and either `ttest_group_checks_LR` (for the checkerboard task) or `ttest_group_press_LR` (for the motor task) as the Overlay. Expand the window by clicking the `Define Overlay -->` button , and set the threshold to `SetA_tstat`. Finally, select a p-value (In our example, we chose 0.01). You can now scroll through the viewer and observe areas of visual activation.  &#x20;

<figure><img src="../../../.gitbook/assets/Screenshot 2025-10-21 at 3.18.54 PM.png" alt=""><figcaption><p>The output of 3dttest++ overlaid onto the MNI template. The transverse images (left) show the checkerboard task and the coronal images (right) show the button pressing task (p=0.01). </p></figcaption></figure>

### 3dMEMA

AFNI's [3dMEMA](https://afni.nimh.nih.gov/pub/dist/doc/htmldoc/programs/alpha/3dMEMA_sphx.html) performs a "mixed effects meta analysis", which, based on your experimental design, could take the form of t-tests, ANOVAs, ANCOVAs, and more. 3dMEMA differs from 3dttest++  in that it weights each subject's beta coefficient according to the respective t-statistic. This means that voxels with higher t-values will be weighted more heavily in the group analysis. To achieve this, you must provide the t-statistic sub-brick as well as the beta coefficient (both output from 3dREMLfit).&#x20;

{% hint style="info" %}
3dMEMA requires R.
{% endhint %}

{% code title="gen_group_command_3dMEMA.sh" %}
```bash
#!/bin/bash
#SBATCH -N 1
#SBATCH -c 8
#SBATCH --mem=10G
#SBATCH --time 1:00:00
#SBATCH -J gen_group_command_3dMEMA
#SBATCH --output=logs/gen_group_command_3dMEMA-%A_%a.out
#SBATCH --mail-user example_user@brown.edu 
#SBATCH --mail-type ALL

# To run this, type on the terminal: sbatch gen_group_command_3dMEMA.sh

##########################################################################################################
########################### Create Group Results and Log Directories ###############################################
##########################################################################################################

bidsdir=/path/to/bids # <--- FILL THIS IN
outdir=$bidsdir/derivatives/afni/groupresults
mkdir -p "$outdir"

echo "Creating group results directory at $outdir"

# Copy group mask into output directory (You can use the group mask from any subject)

mask=$bidsdir/derivatives/afni/sub-101/dualsession/sub-101.dualsession.results/mask_group+tlrc.HEAD
mask_brik=${mask%.HEAD}.BRIK

if [[ -f "$mask" && -f "$mask_brik" ]]; then
    cp "$mask" "$mask_brik" "$outdir/"
    echo "Copied mask to output directory."
else
    echo "Missing mask."
fi

# Use the 'while read' loop to iterate over subjects.txt and copy data files
while read subID; do
    src=$bidsdir/derivatives/afni/${subID}/dualsession/${subID}.dualsession.results/stats.${subID}_dualsession_REML+tlrc.HEAD
    src_brik=${src%.HEAD}.BRIK

    if [[ -f "$src" && -f "$src_brik" ]]; then
        cp "$src" "$src_brik" "$outdir/"
        echo "Copied stats for $subID"
    else
        echo "Missing REML stats for $subID"
    fi
done < subjects.txt

logdir=$bidsdir/derivatives/afni/scripts/logs
mkdir -p $logdir

echo "Creating log directory at $logdir"

cd $outdir

##########################################################################################################
####################### Run Group Statistics with 3dMEMA #################################################
##########################################################################################################

module load r

# Allow AFNI to use system R instead of internal R_io.so
export AFNI_ALLOW_SYSTEM_R=YES

echo "AFNI 3dMEMA requires R to run. Searching for R installation:"
echo "Rscript: $(which Rscript)"

# Run 3dMEMA for the checks task
gen_group_command.py \
    -command 3dMEMA \
    -write_script cmd.mema.checks  \
    -dsets $outdir/*REML*.HEAD  \
    -subs_betas "left_vs_right_chx#0_Coef" \
    -subs_tstats "left_vs_right_chx#0_Tstat" \
    -prefix mema_group_checks_LR \
    -options -mask mask_group+tlrc

tcsh -xef cmd.mema.checks |& tee $logdir/output.mema.checks.log

# Run 3dMEMA for the keypress task
gen_group_command.py \
    -command 3dMEMA \
    -write_script cmd.mema.keypress  \
    -dsets $outdir/*REML*.HEAD  \
    -subs_betas "left_vs_right_press#0_Coef" \
    -subs_tstats "left_vs_right_press#0_Tstat" \
    -prefix mema_group_keypress_LR \
    -options -mask mask_group+tlrc

tcsh -xef cmd.mema.keypress |& tee $logdir/output.mema.keypress.log

```
{% endcode %}

#### View the Output

In a terminal, navigate to the output directory and open afni by typing `afni` on the command line. Using the afni GUI, select `MNI152_2009_template.nii.gz` as the Underlay, and mema`_group_checks_LR` as the Overlay. Expand the window by clicking the `Define Overlay -->` button , and set the threshold to `SetA_tstat`. Finally, select a p-value (In our example, we chose 0.01). You can now scroll through the viewer and observe areas of visual activation.&#x20;

<figure><img src="../../../.gitbook/assets/Screenshot 2025-10-21 at 3.19.07 PM.png" alt=""><figcaption><p>The output of 3dMEMA overlaid onto the MNI template. The transverse images (left) show the checkerboard task and the coronal images (right) show the button pressing task (p=0.005). </p></figcaption></figure>
